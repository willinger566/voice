<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡è¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .recording {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .emotion-card {
            transition: all 0.3s ease;
        }
        .emotion-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ  -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-microphone-alt text-2xl"></i>
                    <h1 class="text-2xl font-bold">ä¸­æ–‡è¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ç³»ç»Ÿ</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="statusIndicator" class="flex items-center">
                        <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                        <span>ç³»ç»Ÿå°±ç»ª</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- ä¸»é¢æ¿ -->
        <div class="grid md:grid-cols-2 gap-6">
            <!-- å·¦ä¾§ï¼šå½•éŸ³/ä¸Šä¼ é¢æ¿ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-upload mr-3 text-purple-500"></i>
                    éŸ³é¢‘è¾“å…¥
                </h2>

                <!-- å½•éŸ³æŒ‰é’® -->
                <div class="mb-6">
                    <button id="recordBtn" class="w-full gradient-bg text-white py-4 px-6 rounded-lg font-bold text-lg flex items-center justify-center space-x-3 hover:opacity-90 transition">
                        <i class="fas fa-microphone text-xl"></i>
                        <span id="recordBtnText">å¼€å§‹å½•éŸ³</span>
                    </button>
                    <p class="text-sm text-gray-500 mt-2 text-center">ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•åˆ¶è¯­éŸ³</p>
                </div>

                <div class="border-t border-gray-200 my-6"></div>

                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        æˆ–ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                    </label>
                    <input type="file" id="audioFile" accept="audio/*" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500">
                    <p class="text-sm text-gray-500 mt-2">æ”¯æŒWAV, MP3, FLACæ ¼å¼</p>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button id="submitBtn" class="w-full mt-6 bg-purple-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-purple-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-paper-plane mr-2"></i>
                    åˆ†ææƒ…æ„Ÿ
                </button>

                <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
                <div id="audioPlayerContainer" class="mt-6 hidden">
                    <label class="block text-gray-700 font-semibold mb-2">éŸ³é¢‘é¢„è§ˆ</label>
                    <audio id="audioPlayer" controls class="w-full"></audio>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœæ˜¾ç¤º -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-purple-500"></i>
                    è¯†åˆ«ç»“æœ
                </h2>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="loadingState" class="hidden text-center py-12">
                    <i class="fas fa-spinner fa-spin text-5xl text-purple-500 mb-4"></i>
                    <p class="text-gray-600">æ­£åœ¨åˆ†ææƒ…æ„Ÿ...</p>
                </div>

                <!-- ç»“æœæ˜¾ç¤º -->
                <div id="resultContainer" class="hidden">
                    <!-- ä¸»è¦æƒ…æ„Ÿ -->
                    <div class="text-center mb-6 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                        <p class="text-gray-600 mb-2">æ£€æµ‹åˆ°çš„æƒ…æ„Ÿ</p>
                        <div id="mainEmotion" class="text-4xl font-bold text-purple-600 mb-2">-</div>
                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-gray-600">ç½®ä¿¡åº¦:</span>
                            <span id="confidence" class="text-2xl font-bold text-green-600">-</span>
                        </div>
                    </div>

                    <!-- æ¦‚ç‡åˆ†å¸ƒå›¾è¡¨ -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">æƒ…æ„Ÿæ¦‚ç‡åˆ†å¸ƒ</h3>
                        <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="probChart"></canvas>
                    </div>

                    <!-- æƒ…æ„Ÿå¡ç‰‡ -->
                    <div id="emotionCards" class="grid grid-cols-2 gap-3">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åˆå§‹çŠ¶æ€ -->
                <div id="initialState" class="text-center py-12 text-gray-400">
                    <i class="fas fa-music text-6xl mb-4"></i>
                    <p>è¯·å½•åˆ¶æˆ–ä¸Šä¼ éŸ³é¢‘ä»¥å¼€å§‹åˆ†æ</p>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-info-circle mr-3 text-blue-500"></i>
                ä½¿ç”¨è¯´æ˜
            </h2>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl mb-2">ğŸ“</div>
                    <h3 class="font-bold mb-2">æ”¯æŒçš„æƒ…æ„Ÿç±»åˆ«</h3>
                    <p class="text-sm text-gray-600">ä¸­æ€§ã€é«˜å…´ã€æ‚²ä¼¤ã€æ„¤æ€’ã€ææƒ§ã€æƒŠè®¶</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl mb-2">ğŸ¤</div>
                    <h3 class="font-bold mb-2">å½•éŸ³å»ºè®®</h3>
                    <p class="text-sm text-gray-600">åœ¨å®‰é™ç¯å¢ƒä¸‹å½•åˆ¶3-10ç§’çš„æ¸…æ™°è¯­éŸ³</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl mb-2">ğŸ“Š</div>
                    <h3 class="font-bold mb-2">å‡†ç¡®ç‡è¯´æ˜</h3>
                    <p class="text-sm text-gray-600">æ¨¡å‹åœ¨CASIAæ•°æ®é›†ä¸Šè¾¾åˆ°80%+å‡†ç¡®ç‡</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_URL = 'http://localhost:8000';
        
        // å…¨å±€å˜é‡
        let mediaRecorder;
        let audioChunks = [];
        let recordedBlob;
        let probChart;

        // æƒ…æ„Ÿæ ‡ç­¾æ˜ å°„
        const emotionLabels = {
            'neutral': 'ä¸­æ€§',
            'happy': 'é«˜å…´',
            'sad': 'æ‚²ä¼¤',
            'angry': 'æ„¤æ€’',
            'fearful': 'ææƒ§',
            'surprised': 'æƒŠè®¶'
        };

        const emotionColors = {
            'neutral': '#6B7280',
            'happy': '#F59E0B',
            'sad': '#3B82F6',
            'angry': '#EF4444',
            'fearful': '#8B5CF6',
            'surprised': '#10B981'
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAPIHealth();
            initializeEventListeners();
        });

        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                const indicator = document.getElementById('statusIndicator');
                if (data.status === 'healthy' && data.model_loaded) {
                    indicator.innerHTML = `
                        <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                        <span>ç³»ç»Ÿå°±ç»ª</span>
                    `;
                } else {
                    indicator.innerHTML = `
                        <span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
                        <span>ç³»ç»Ÿå¯åŠ¨ä¸­</span>
                    `;
                }
            } catch (error) {
                const indicator = document.getElementById('statusIndicator');
                indicator.innerHTML = `
                    <span class="w-3 h-3 bg-red-400 rounded-full mr-2"></span>
                    <span>è¿æ¥å¤±è´¥</span>
                `;
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            document.getElementById('recordBtn').addEventListener('click', toggleRecording);
            document.getElementById('audioFile').addEventListener('change', handleFileSelect);
            document.getElementById('submitBtn').addEventListener('click', submitAudio);
        }

        // å½•éŸ³æ§åˆ¶
        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            const btnText = document.getElementById('recordBtnText');
            
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // å¼€å§‹å½•éŸ³
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioURL = URL.createObjectURL(recordedBlob);
                        
                        const audioPlayer = document.getElementById('audioPlayer');
                        audioPlayer.src = audioURL;
                        document.getElementById('audioPlayerContainer').classList.remove('hidden');
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    btn.classList.add('recording', 'bg-red-600');
                    btnText.textContent = 'åœæ­¢å½•éŸ³';
                } catch (error) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                }
            } else {
                // åœæ­¢å½•éŸ³
                mediaRecorder.stop();
                btn.classList.remove('recording', 'bg-red-600');
                btnText.textContent = 'å¼€å§‹å½•éŸ³';
            }
        }

        // æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                recordedBlob = file;
                const audioURL = URL.createObjectURL(file);
                
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioURL;
                document.getElementById('audioPlayerContainer').classList.remove('hidden');
            }
        }

        // æäº¤éŸ³é¢‘
        async function submitAudio() {
            if (!recordedBlob) {
                alert('è¯·å…ˆå½•åˆ¶æˆ–ä¸Šä¼ éŸ³é¢‘');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('initialState').classList.add('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            
            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('file', recordedBlob, 'audio.wav');
            
            try {
                const response = await fetch(`${API_URL}/predict`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('é¢„æµ‹å¤±è´¥');
                }
                
                const result = await response.json();
                displayResult(result);
            } catch (error) {
                alert('é”™è¯¯: ' + error.message);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('initialState').classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(result) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultContainer').classList.remove('hidden');
            
            // æ˜¾ç¤ºä¸»è¦æƒ…æ„Ÿ
            const emotionChinese = emotionLabels[result.predicted_emotion] || result.predicted_emotion;
            document.getElementById('mainEmotion').textContent = emotionChinese;
            document.getElementById('confidence').textContent = (result.confidence * 100).toFixed(1) + '%';
            
            // ç»˜åˆ¶æ¦‚ç‡åˆ†å¸ƒå›¾
            drawProbabilityChart(result.all_probabilities);
            
            // ç”Ÿæˆæƒ…æ„Ÿå¡ç‰‡
            generateEmotionCards(result.all_probabilities);
        }

        // ç»˜åˆ¶æ¦‚ç‡å›¾è¡¨
        function drawProbabilityChart(probabilities) {
            const ctx = document.getElementById('probChart').getContext('2d');
            
            if (probChart) {
                probChart.destroy();
            }
            
            const labels = Object.keys(probabilities).map(k => emotionLabels[k] || k);
            const data = Object.values(probabilities).map(v => v * 100);
            const colors = Object.keys(probabilities).map(k => emotionColors[k]);
            
            probChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¦‚ç‡ (%)',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆæƒ…æ„Ÿå¡ç‰‡
        function generateEmotionCards(probabilities) {
            const container = document.getElementById('emotionCards');
            container.innerHTML = '';
            
            for (const [emotion, prob] of Object.entries(probabilities)) {
                const emotionChinese = emotionLabels[emotion] || emotion;
                const percentage = (prob * 100).toFixed(1);
                const color = emotionColors[emotion];
                
                const card = document.createElement('div');
                card.className = 'emotion-card p-4 rounded-lg border-2';
                card.style.borderColor = color;
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-bold" style="color: ${color}">${emotionChinese}</span>
                        <span class="text-lg font-bold">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full" style="width: ${percentage}%; background-color: ${color}"></div>
                    </div>
                `;
                
                container.appendChild(card);
            }
        }
    </script>
</body>
</html>